---
title: "EmptyDroplet_doublet_ambientRNA_detection"
author: "JD Luo"
date: "2023-07-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Process counting with Cellranger

## Gathering sample information
- Assign path to the cellranger counting matrix of each sample
- rawMTX: the path to raw count matrix
- filtMTX: the path to filtered count matrix 
- time: time point
- rep: replications
```{r samInfo,include=TRUE,eval=FALSE}
sample_sheet <- data.frame(sample_id=c("P1_rep1","P1_rep2","P14_rep1","P14_rep2",
                                       "Ad2wk_rep1","Ad2wk_rep2","Ad2mon_rep1","Ad2mon_rep2"),
                           rawMTX=c("P1_rep1/raw_feature_bc_matrix/",
                                    "P1_rep2/raw_feature_bc_matrix/",
                                    "P14_rep1/raw_feature_bc_matrix/",
                                    "P14_rep2/raw_feature_bc_matrix/",
                                    "2wk_rep1/raw_feature_bc_matrix/",
                                    "2wk_rep2/raw_feature_bc_matrix/",
                                    "2mon_rep1/raw_feature_bc_matrix/",
                                    "2mon_rep2/raw_feature_bc_matrix/"),
                           filtMTX=c("P1_rep1/filtered_feature_bc_matrix/",
                                     "P1_rep2/filtered_feature_bc_matrix/",
                                     "P14_rep1/filtered_feature_bc_matrix/",
                                     "P14_rep2/filtered_feature_bc_matrix/",
                                     "2wk_rep1/filtered_feature_bc_matrix/",
                                     "2wk_rep2/filtered_feature_bc_matrix/",
                                     "2mon_rep1/filtered_feature_bc_matrix/",
                                     "2mon_rep2/filtered_feature_bc_matrix/"),
                           time=c(rep("P1",2),rep("P14",2),rep("Ad2wk",2),rep("Ad2mon",2)),
                           rep=c(rep(c("rep1","rep2"),4)),
                           stringsAsFactors = FALSE)
write.table(sample_sheet,file = "sampleSheet_snSeq_AntNeuron_allSample_20230227.csv",
            sep=",",quote = FALSE,row.names = FALSE)
```

## Detect and remove empty droplets
* The empty droplets of each sample were identified and removed by using DropletUtils. [link to bioconductor page](https://bioconductor.org/packages/release/bioc/html/DropletUtils.html)
* Input: raw count matrix generated by Cellranger
* Steps:
  + read raw count matrix into SingleCellExperiment object (sce.pbmc): DropletUtils::read10XCounts()
  + detect empty droplets by the distribution of UMI count per cell: DropletUtils::emptyDrops()
  + subset the cells whose FDR < 0.0001
  + extract the count matrix from subset SingleCellExperiment object
* Output in a list of matrix format
  + raw count matrix extracted from cellranger
  + count matrix filtered by using DropletUtls
```{r emptyDroplet_proc,include=TRUE,eval=FALSE}
# read sample sheet containing raw/filt matrix of cellranger for each sample
sample_sheet <- read.delim("sampleSheet_snSeq_AntNeuron_allSample_20230227.csv",
                           sep=",",stringsAsFactors = FALSE)
#
# process raw matrix, detect empty droplets, and remove empty droplets
mtx_res <- lapply(sample_sheet$sample_id,function(samID,samSheet){
  raw_mtx <- samSheet$rawMTX[samSheet$sample_id==samID] # assign the path to raw count matrix (GEX format)
  sce.pbmc <- read10xCounts(raw_mtx, col.names=TRUE) # read raw count matrix file into SingleCellExperiment object
  # raw_mat <- counts(sce.pbmc) # extact count matix in matrix format
  #
  # for knee plot ~ redundant
  # bcrank <- barcodeRanks(counts(sce.pbmc)) 
  # knee <- metadata(bcrank)$knee
  # cell_kp <- rownames(bcrank)[bcrank$total >= knee]
  #
  set.seed(100)
  e.out <- emptyDrops(counts(sce.pbmc)) # detect empty droplets by the distribution
  # See ?emptyDrops for an explanation of why there are NA values.
  # summary(e.out$FDR <= 0.001)
  # table(Sig=e.out$FDR <= 0.001, Limited=e.out$Limited)
  #
  sce.sub <- sce.pbmc[,which(e.out$FDR < 0.0001)]
  filt_mat <- counts(sce.sub)
  #
  res <- list("raw"=raw_mat,"filt"=filt_mat)
  base::save("raw_mat","filt_mat",file = paste0("procMTX_",samID,"_20230227.RData"))
  # abc <- base::load("procMTX_P1_rep1_20230227.RData")
  return(res)},sample_sheet)
names(mtx_res) <- sample_sheet$sample_id
```

## Sessions
```{r session,include=TRUE,eval=TRUE}
```

Bioinformatics Resource Center, Ther Rockefeller University